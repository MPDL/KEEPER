{"version":3,"sources":["pages/file-history-old/history-item.js","file-history-old.js"],"names":["moment","locale","window","app","config","lang","HistoryItem","props","onMouseEnter","setState","active","onMouseLeave","onItemRestore","e","preventDefault","item","state","this","downloadUrl","URLDecorator","getUrl","type","filePath","objID","rev_file_id","userProfileURL","siteRoot","encodeURIComponent","creator_email","viewUrl","historyRepoID","commit_id","Utils","encodePath","diffUrl","className","datetime","time","is","title","ctime","format","fromNow","index","gettext","src","creator_avatar_url","alt","href","target","creator_name","bytesToSize","size","canDownload","canCompare","React","Component","MoreMenu","dropdownToggle","dropdownOpen","isOpen","toggle","direction","tag","data-toggle","aria-expanded","right","onClick","PureComponent","FileHistory","listNewHistoryRecords","PER_PAGE","editUtilities","listFileHistoryRecords","then","res","data","isLoading","Error","initNewRecords","listOldHistoryRecords","repoID","seafileAPI","listOldFileHistoryRecords","initOldRecords","onScrollHandler","event","clientHeight","scrollHeight","isBottom","scrollTop","hasMore","reloadMore","isReloadingData","useNewAPI","currentPage","updateNewRecords","commitID","nextCommit","oldFilePath","updateOldRecords","commitId","path","revertFile","success","refershFileList","onSearchedClick","searchedItem","handleSearchedItemClick","historyList","undefined","result","total_count","length","oldPath","old_path","concat","slice","page","next_start_commit","rev_renamed_old_path","id","showCloseSidePanelIcon","onScroll","fileName","width","map","ReactDOM","render","document","getElementById"],"mappings":"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","file":"static/js/fileHistoryOld.chunk.js","sourcesContent":["import React, { Fragment } from 'react';\nimport PropTypes from 'prop-types';\nimport moment from 'moment';\nimport { Utils } from '../../utils/utils';\nimport { gettext, siteRoot, filePath, historyRepoID } from '../../utils/constants';\nimport URLDecorator from '../../utils/url-decorator';\nimport { Dropdown, DropdownToggle, DropdownMenu, DropdownItem } from 'reactstrap';\n\nmoment.locale(window.app.config.lang);\n\nconst propTypes = {\n  item: PropTypes.object.isRequired,\n  index: PropTypes.number.isRequired,\n  canDownload: PropTypes.bool.isRequired,\n  canCompare: PropTypes.bool.isRequired,\n  onItemRestore: PropTypes.func.isRequired,\n};\n\nclass HistoryItem extends React.Component {\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      active: false,\n    };\n  }\n\n  onMouseEnter = () => {\n    this.setState({\n      active: true\n    });\n  }\n\n  onMouseLeave = () => {\n    this.setState({\n      active: false\n    });\n  }\n\n  onItemRestore = (e) => {\n    e.preventDefault();\n    this.props.onItemRestore(this.props.item);\n  }\n\n  render() {\n    let item = this.props.item;\n    let downloadUrl = URLDecorator.getUrl({type: 'download_historic_file', filePath: filePath, objID: item.rev_file_id});\n    let userProfileURL = `${siteRoot}profile/${encodeURIComponent(item.creator_email)}/`;\n    let viewUrl = `${siteRoot}repo/${historyRepoID}/history/files/?obj_id=${item.rev_file_id}&commit_id=${item.commit_id}&p=${Utils.encodePath(filePath)}`;\n    let diffUrl = `${siteRoot}repo/text_diff/${historyRepoID}/?commit=${item.commit_id}&p=${Utils.encodePath(filePath)}`;\n    return (\n      <Fragment>\n        <tr onMouseEnter={this.onMouseEnter} onMouseLeave={this.onMouseLeave} className={this.state.active ? 'tr-highlight' : ''}>\n          <td>\n            <time datetime={item.time} is=\"relative-time\" title={moment(item.ctime).format('llll')}>{moment(item.ctime).fromNow()}</time>\n            {this.props.index === 0 && gettext('(current version)')}\n          </td>\n          <td>\n            <img className=\"avatar\" src={item.creator_avatar_url} alt=''></img>{' '}\n            <a href={userProfileURL} target='_blank' className=\"username\">{item.creator_name}</a>\n          </td>\n          <td>{Utils.bytesToSize(item.size)}</td>\n          <td>\n            {this.state.active &&\n              <MoreMenu\n                index={this.props.index}\n                downloadUrl={downloadUrl}\n                viewUrl={viewUrl}\n                diffUrl={diffUrl}\n                onItemRestore={this.onItemRestore}\n                canDownload={this.props.canDownload}\n                canCompare={this.props.canCompare}\n              />\n            }\n          </td>\n        </tr>\n      </Fragment>\n    );\n  }\n}\n\nHistoryItem.propTypes = propTypes;\n\n\nconst MoreMenuPropTypes = {\n  index: PropTypes.number.isRequired,\n  downloadUrl: PropTypes.string.isRequired,\n  viewUrl: PropTypes.string.isRequired,\n  diffUrl: PropTypes.string.isRequired,\n  onItemRestore: PropTypes.func.isRequired,\n  canDownload: PropTypes.bool.isRequired,\n  canCompare: PropTypes.bool.isRequired,\n};\n\nclass MoreMenu extends React.PureComponent {\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      dropdownOpen: false\n    };\n  }\n\n  dropdownToggle = () => {\n    this.setState({ dropdownOpen: !this.state.dropdownOpen });\n  }\n\n  render() {\n    const { index, downloadUrl, viewUrl, diffUrl, onItemRestore, canCompare, canDownload } = this.props;\n    return (\n      <Dropdown isOpen={this.state.dropdownOpen} toggle={this.dropdownToggle} direction=\"down\" className=\"mx-1 old-history-more-operation\">\n        <DropdownToggle\n          tag='i'\n          className='fa fa-ellipsis-v'\n          title={gettext('More Operations')}\n          data-toggle=\"dropdown\"\n          aria-expanded={this.state.dropdownOpen}\n        >\n        </DropdownToggle>\n        <DropdownMenu className=\"drop-list\" right={true}>\n          {index !== 0 && <a href=\"#\" onClick={onItemRestore}><DropdownItem>{gettext('Restore')}</DropdownItem></a>}\n          {canDownload && <a href={downloadUrl}><DropdownItem>{gettext('Download')}</DropdownItem></a>}\n          <a href={viewUrl}><DropdownItem>{gettext('View')}</DropdownItem></a>\n          {/*canCompare && <a href={diffUrl}><DropdownItem>{gettext('Diff')}</DropdownItem></a>*/}\n        </DropdownMenu>\n      </Dropdown>\n    );\n  }\n}\n\nMoreMenu.propTypes = MoreMenuPropTypes;\n\nexport default HistoryItem;\n","import React, { Fragment } from 'react';\nimport ReactDOM from 'react-dom';\nimport { Button } from 'reactstrap';\nimport { Utils } from './utils/utils';\nimport { seafileAPI } from './utils/seafile-api';\nimport { gettext, PER_PAGE, filePath, fileName, historyRepoID, useNewAPI, canDownload, canCompare } from './utils/constants';\nimport editUtilities from './utils/editor-utilities';\nimport Loading from './components/loading';\nimport Logo from './components/logo';\nimport CommonToolbar from './components/toolbar/common-toolbar';\nimport HistoryItem from './pages/file-history-old/history-item';\n\nimport './css/layout.css';\nimport './css/toolbar.css';\nimport './css/search.css';\nimport './css/file-history-old.css';\n\nclass FileHistory extends React.Component {\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      historyList: [],\n      currentPage: 1,\n      hasMore: false,\n      nextCommit: undefined,\n      filePath: '',\n      oldFilePath: '',\n      isLoading: true,\n      isReloadingData: false,\n    };\n  }\n\n  componentDidMount() {\n    if (useNewAPI) {\n      this.listNewHistoryRecords(filePath, PER_PAGE);\n    } else {\n      this.listOldHistoryRecords(historyRepoID, filePath);\n    }\n  }\n\n  listNewHistoryRecords = (filePath, PER_PAGE) => {\n    editUtilities.listFileHistoryRecords(filePath, 1, PER_PAGE).then(res => {\n      let historyData = res.data;\n      if (!historyData) {\n        this.setState({isLoading: false});\n        throw Error('There is an error in server.');\n      }\n      this.initNewRecords(res.data);\n    });\n  }\n\n  listOldHistoryRecords = (repoID, filePath) => {\n    seafileAPI.listOldFileHistoryRecords(repoID, filePath).then((res) => {\n      let historyData = res.data;\n      if (!historyData) {\n        this.setState({isLoading: false});\n        throw Error('There is an error in server.');\n      }\n      this.initOldRecords(res.data);\n    });\n  }\n\n  initNewRecords(result) {\n    if (result.total_count < 5) {\n      if (result.data.length) {\n        let commitID = result.data[result.data.length-1].commit_id;\n        let path = result.data[result.data.length-1].path;\n        let oldPath = result.data[result.data.length-1].old_path;\n        path = oldPath ? oldPath : path;\n        seafileAPI.listOldFileHistoryRecords(historyRepoID, path, commitID).then((res) => {\n          if (!res.data) {\n            this.setState({isLoading: false});\n            throw Error('There is an error in server.');\n          }\n          this.setState({\n            historyList: result.data.concat(res.data.data.slice(1, res.data.data.length)),\n            isLoading: false,\n          });\n        });\n      } else {\n        seafileAPI.listOldFileHistoryRecords(historyRepoID, filePath).then((res) => {\n          if (!res.data) {\n            this.setState({isLoading: false});\n            throw Error('There is an error in server.');\n          }\n          this.setState({\n            historyList: res.data.data,\n            isLoading: false,\n          });\n        });\n      }\n    } else {\n      this.setState({\n        historyList: result.data,\n        currentPage: result.page,\n        hasMore: result.total_count > (PER_PAGE * this.state.currentPage),\n        isLoading: false,\n      });\n    }\n  }\n\n  initOldRecords(result) {\n    if (result.data.length) {\n      this.setState({\n        historyList: result.data,\n        nextCommit: result.next_start_commit,\n        filePath: result.data[result.data.length-1].path,\n        oldFilePath: result.data[result.data.length-1].rev_renamed_old_path,\n        isLoading: false,\n      });\n    } else {\n      this.setState({nextCommit: result.next_start_commit,});\n      if (this.state.nextCommit) {\n        seafileAPI.listOldFileHistoryRecords(historyRepoID, filePath, this.state.nextCommit).then((res) => {\n          this.initOldRecords(res.data);\n        });\n      } else {\n        this.setState({isLoading: false});\n      }\n    }\n  }\n\n  onScrollHandler = (event) => {\n    const clientHeight = event.target.clientHeight;\n    const scrollHeight = event.target.scrollHeight;\n    const scrollTop = event.target.scrollTop;\n    const isBottom = (clientHeight + scrollTop + 1 >= scrollHeight);\n    let hasMore = this.state.hasMore;\n    if (isBottom && hasMore) {\n      this.reloadMore();\n    }\n  }\n\n  reloadMore = () => {\n    if (!this.state.isReloadingData) {\n      if (useNewAPI) {\n        let currentPage = this.state.currentPage + 1;\n        this.setState({\n          currentPage: currentPage,\n          isReloadingData: true,\n        });\n        editUtilities.listFileHistoryRecords(filePath, currentPage, PER_PAGE).then(res => {\n          this.updateNewRecords(res.data);\n        });\n      } else {\n        let commitID = this.state.nextCommit;\n        let filePath = this.state.filePath;\n        let oldFilePath = this.state.oldFilePath;\n        this.setState({isReloadingData: true});\n        if (oldFilePath) {\n          seafileAPI.listOldFileHistoryRecords(historyRepoID, oldFilePath, commitID).then((res) => {\n            this.updateOldRecords(res.data, oldFilePath);\n          });\n        } else {\n          seafileAPI.listOldFileHistoryRecords(historyRepoID, filePath, commitID).then((res) => {\n            this.updateOldRecords(res.data, filePath);\n          });\n        }\n      }\n    }\n  }\n\n  updateNewRecords(result) {\n    this.setState({\n      historyList: [...this.state.historyList, ...result.data],\n      currentPage: result.page,\n      hasMore: result.total_count > (PER_PAGE * this.state.currentPage),\n      isReloadingData: false,\n    });\n  }\n\n  updateOldRecords(result, filePath) {\n    if (result.data.length) {\n      this.setState({\n        historyList: [...this.state.historyList, ...result.data],\n        nextCommit: result.next_start_commit,\n        filePath: result.data[result.data.length-1].path,\n        oldFilePath: result.data[result.data.length-1].rev_renamed_old_path,\n        isReloadingData: false,\n      });\n    } else {\n      this.setState({nextCommit: result.next_start_commit,});\n      if (this.state.nextCommit) {\n        seafileAPI.listOldFileHistoryRecords(historyRepoID, filePath, this.state.nextCommit).then((res) => {\n          this.updateOldRecords(res.data, filePath);\n        });\n      }\n    }\n  }\n\n  onItemRestore = (item) => {\n    let commitId = item.commit_id;\n    let filePath = item.path;\n    editUtilities.revertFile(filePath, commitId).then(res => {\n      if (res.data.success) {\n        this.setState({isLoading: true});\n        this.refershFileList();\n      }\n    });\n  }\n\n  refershFileList() {\n    if (useNewAPI) {\n      editUtilities.listFileHistoryRecords(filePath, 1, PER_PAGE).then((res) => {\n        this.initNewRecords(res.data);\n      });\n    } else {\n      seafileAPI.listOldFileHistoryRecords(historyRepoID, filePath).then((res) => {\n        this.initOldRecords(res.data);\n      });\n    }\n  }\n\n  onSearchedClick = (searchedItem) => {\n    Utils.handleSearchedItemClick(searchedItem);\n  }\n\n  render() {\n    return (\n      <Fragment>\n        <div id=\"header\" className=\"old-history-header\">\n          <div className=\"logo\">\n            <Logo showCloseSidePanelIcon={false}/>\n          </div>\n          <div className='toolbar'>\n            <CommonToolbar onSearchedClick={this.onSearchedClick} />\n          </div>\n        </div>\n        <div id=\"main\" onScroll={this.onScrollHandler}>\n          <div className=\"old-history-main\">\n            <Fragment>\n              <a href=\"javascript:window.history.back()\" className=\"go-back\" title=\"Back\">\n                <span className=\"fas fa-chevron-left\"></span>\n              </a>\n              <h2><span className=\"file-name\">{fileName}</span>{' '}{gettext('History Versions')}</h2>\n            </Fragment>\n            <Fragment>\n              <table className=\"commit-list\">\n                <thead>\n                  <tr>\n                    <th width=\"40%\" >{gettext('Time')}</th>\n                    <th width=\"30%\" >{gettext('Modifier')}</th>\n                    <th width=\"25%\" >{gettext('Size')}</th>\n                    <th width=\"5%\" ></th>\n                  </tr>\n                </thead>\n                {!this.state.isLoading &&\n                  <tbody>\n                    {this.state.historyList.map((item, index) => {\n                      return (\n                        <HistoryItem\n                          key={index}\n                          item={item}\n                          index={index}\n                          canDownload={canDownload}\n                          canCompare={canCompare}\n                          onItemRestore={this.onItemRestore}\n                        />\n                      );\n                    })}\n                  </tbody>\n                }\n              </table>\n              {(this.state.isReloadingData || this.state.isLoading) && <Loading />}\n              {this.state.nextCommit && !this.state.isLoading && !this.state.isReloadingData &&\n                <Button className=\"get-more-btn\" onClick={this.reloadMore}>{gettext('More')}</Button>\n              }\n            </Fragment>\n          </div>\n        </div>\n      </Fragment>\n    );\n  }\n}\n\nReactDOM.render (\n  <FileHistory />,\n  document.getElementById('wrapper')\n);\n"],"sourceRoot":""}