{"version":3,"sources":["view-file-text.js"],"names":["_window$app$pageOptio","window","app","pageOptions","err","fileExt","fileContent","repoID","filePath","fileName","canEditFile","username","options","lineNumbers","mode","Utils","chooseLanguage","extraKeys","theme","textWrapping","lineWrapping","readOnly","cursorBlinkRate","ViewFileText","_React$Component","_inherits","_super","_createSuper","props","_this","_classCallCheck","call","updateContent","newContent","setState","needSave","content","addParticipant","seafileAPI","addFileParticipants","then","res","status","isParticipant","getParticipants","listFileParticipants","participants","data","participant_list","length","every","participant","email","onParticipantsChange","state","isSaving","onSave","bind","_assertThisInitialized","_createClass","key","value","_this2","this","getUpdateLink","uploadLink","updateFile","toaster","success","gettext","duration","_jsx","FileView","FileContent","React","Component","_React$Component2","_super2","apply","arguments","FileViewTip","className","children","CodeMirror","ref","onChange","ReactDOM","render","document","getElementById"],"mappings":"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","file":"static/js/viewFileText.chunk.js","sourcesContent":["import React from 'react';\nimport ReactDOM from 'react-dom';\nimport PropTypes from 'prop-types';\nimport toaster from './components/toast';\nimport { Utils } from './utils/utils';\nimport { gettext } from './utils/constants';\nimport FileView from './components/file-view/file-view';\nimport FileViewTip from './components/file-view/file-view-tip';\nimport { seafileAPI } from './utils/seafile-api';\n\nimport CodeMirror from 'react-codemirror';\nimport 'codemirror/mode/javascript/javascript';\nimport 'codemirror/mode/css/css';\nimport 'codemirror/mode/clike/clike';\nimport 'codemirror/mode/php/php';\nimport 'codemirror/mode/sql/sql';\nimport 'codemirror/mode/vue/vue';\nimport 'codemirror/mode/xml/xml';\nimport 'codemirror/mode/go/go';\nimport 'codemirror/mode/python/python';\nimport 'codemirror/mode/htmlmixed/htmlmixed';\nimport 'codemirror/lib/codemirror.css';\n\nimport './css/text-file-view.css';\n\nconst {\n  err, fileExt, fileContent, repoID, filePath, fileName, canEditFile, username\n} = window.app.pageOptions;\n\nconst options = {\n  lineNumbers: true,\n  mode: Utils.chooseLanguage(fileExt),\n  extraKeys: {'Ctrl': 'autocomplete'},\n  theme: 'default',\n  textWrapping: true,\n  lineWrapping: true,\n  readOnly: !canEditFile,\n  cursorBlinkRate: canEditFile ? 530 : -1,   // default is 530ms\n};\n\nclass ViewFileText extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = {\n      content: fileContent,\n      needSave: false,\n      isSaving: false,\n      participants: [],\n    };\n    this.onSave=this.onSave.bind(this);\n    this.isParticipant = false;\n  }\n\n\n  updateContent = (newContent) => {\n    this.setState({\n      needSave: true,\n      content: newContent,\n    });\n  }\n\n  onSave () {\n    if (!this.isParticipant) {\n      this.addParticipant();\n    }\n    let dirPath = '/';\n    return (\n      seafileAPI.getUpdateLink(repoID, dirPath).then((res) => {\n        const uploadLink = res.data;\n        this.setState({\n          isSaving: true\n        });\n        return seafileAPI.updateFile(\n          uploadLink,\n          filePath,\n          fileName,\n          this.state.content\n        ).then(() => {\n          toaster.success(gettext('Successfully saved'), {\n            duration: 2\n          });\n          this.setState({\n            isSaving: false,\n            needSave: false\n          });\n        });\n      })\n    );\n  }\n\n  addParticipant = () => {\n    seafileAPI.addFileParticipants(repoID, filePath, [username]).then((res) => {\n      if (res.status === 200) {\n        this.isParticipant = true;\n        this.getParticipants();\n      }\n    });\n  }\n\n  getParticipants = () => {\n    seafileAPI.listFileParticipants(repoID, filePath).then((res) => {\n      const participants = res.data.participant_list;\n      this.setState({ participants: participants });\n      if (participants.length > 0) {\n        this.isParticipant = participants.every((participant) => {\n          return participant.email == username;\n        });\n      }\n    });\n  }\n\n  onParticipantsChange = () => {\n    this.getParticipants();\n  }\n\n  componentDidMount() {\n    this.getParticipants();\n  }\n\n  render() {\n    return (\n      <FileView\n        content={\n          <FileContent\n            content={this.state.content}\n            updateContent={this.updateContent}\n          />\n        }\n        isSaving={this.state.isSaving}\n        needSave={this.state.needSave}\n        onSave={this.onSave}\n        participants={this.state.participants}\n        onParticipantsChange={this.onParticipantsChange}\n      />\n    );\n  }\n}\n\nconst propTypes = {\n  updateContent: PropTypes.func.isRequired,\n  content: PropTypes.string.isRequired,\n};\n\nclass FileContent extends React.Component {\n  render() {\n    if (err) {\n      return <FileViewTip />;\n    }\n    return (\n      <div className=\"file-view-content flex-1 text-file-view\">\n        <CodeMirror\n          ref=\"code-mirror-editor\"\n          value={this.props.content}\n          options={options}\n          onChange={this.props.updateContent}\n        />\n      </div>\n    );\n  }\n}\n\nFileContent.propTypes = propTypes;\n\nReactDOM.render (\n  <ViewFileText />,\n  document.getElementById('wrapper')\n);\n"],"sourceRoot":""}